---
- hosts: all
  vars:
    necessary_packages:
      - zsh
      - git
    config_files:
      - .aliases.sh
      - .bindings.sh
      - .exports.sh
      - .functions.sh
      - .fzf.zsh
      - .zshrc
    oh_my_zsh_path: "{{ ansible_env.HOME }}/.oh-my-zsh"
    git_repos:
      - repo: https://github.com/robbyrussell/oh-my-zsh.git
        dest: "{{ oh_my_zsh_path }}"
      - repo: https://github.com/bhilburn/powerlevel9k.git
        dest: "{{ oh_my_zsh_path }}/custom/themes/powerlevel9k"
      - repo: https://github.com/mbadolato/iTerm2-Color-Schemes.git
        dest: "{{ ansible_env.HOME }}/git/mbadolato/iterm2-color"
      - repo: https://github.com/powerline/fonts.git
        dest: "{{ ansible_env.HOME }}/git/powerline/fonts"
      - repo: https://github.com/junegunn/fzf.git
        dest: "{{ ansible_env.HOME }}/.fzf"

  tasks:
    - name: Install packages
      package:
        name: "{{ necessary_packages }}"
        state: present
      when:
        - ansible_system == 'Linux'
      become: true

    - name: "Copy configs from {{ ansible_env.PWD }}"
      file:
        src: "{{ ansible_env.PWD }}/{{ item }}"
        dest: "{{ ansible_env.HOME }}/{{ item }}"
        owner: "{{ ansible_effective_user_id }}"
        group: "{{ ansible_effective_group_id }}"
        state: link
      loop: "{{ config_files }}"
      when: "'ungrouped' in group_names"

    - name: "Copy configs from {{ ansible_env.PWD }}"
      copy:
        src: "{{ item }}"
        dest: "{{ ansible_env.HOME }}/{{ item }}"
        owner: "{{ ansible_effective_user_id }}"
        group: "{{ ansible_effective_group_id }}"
      loop: "{{ config_files }}"
      when: "'ungrouped' not in group_names"

    - name: Clone git repos
      git:
        repo: "{{ item.repo }}"
        dest: "{{ item.dest }}"
        depth: 1
      loop: "{{ git_repos }}"

    - name: Run fzf install script
      shell: "{{ ansible_env.HOME }}/.fzf/install --no-bash --no-fish --bin --64"
