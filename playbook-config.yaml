---
- hosts: localhost
  vars:
    necessary_packages:
      - zsh
      - git
      - curl
      - wget
      - tmux
    git_path: "{{ ansible_env.HOME }}/git"
    dotfiles_path: "{{ git_path }}/reynn/dotfiles"
    git_repos:
      - repo: https://github.com/reynn/dotfiles.git
        dest: "{{ git_path }}/reynn/dotfiles"
      - repo: https://github.com/robbyrussell/oh-my-zsh.git
        dest: "{{ git_path }}/robbyrussell/oh-my-zsh"
      - repo: https://github.com/bhilburn/powerlevel9k.git
        dest: "{{ git_path }}/robbyrussell/oh-my-zsh/custom/themes/powerlevel9k"
      - repo: https://github.com/mbadolato/iTerm2-Color-Schemes.git
        dest: "{{ git_path }}/mbadolato/iterm2-color"
      - repo: https://github.com/powerline/fonts.git
        dest: "{{ git_path }}/powerline/fonts"
      - repo: https://github.com/junegunn/fzf.git
        dest: "{{ git_path }}/junegunn/fzf"
    bin_downloads:
      - name: Ripgrep
        git:
          owner: BurntSushi
          repo: ripgrep
        alias: rg
      - name: JQ
        git:
          owner: stedolan
          repo: jq

  tasks:
    - name: Install packages
      package:
        name: "{{ necessary_packages }}"
        state: present
      when:
        - ansible_system == 'Linux'
      become: true

    - name: "Link .zshrc file"
      file:
        src: "{{ ansible_env.PWD }}/zsh/.zshrc"
        dest: "{{ ansible_env.HOME }}/.zshrc"
        owner: "{{ ansible_effective_user_id }}"
        group: "{{ ansible_effective_group_id }}"
        state: link

    - name: Clone git repos
      git:
        repo: "{{ item.repo }}"
        dest: "{{ item.dest }}"
        depth: 1
      loop: "{{ git_repos }}"

    - name: Run fzf install script
      shell: "{{ git_path }}/junegunn/fzf/install --bin --64"

    - name: Ensure binary dirs exist
      file:
        path: "{{ binary_dir | default(ansible_env.HOME + '/.bins') }}"
        state: directory
        mode: 0755
      tags:
        - binaries

    - include_tasks: "{{ ansible_env.PWD }}/ansible/get-latest-release-from-github.yaml"
      with_items: "{{ bin_downloads }}"
      tags:
        - binaries

    - name: Set the default shell to zsh
      user:
        name: "{{ ansible_user_id }}"
        shell: /bin/zsh
